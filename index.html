<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>実車評価支援ツール（女性音声・最近傍読み上げ・GPX保存先/ファイル名指定）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; top:0; bottom:0; right:0; left:0; }
    #panel{
      position:absolute; top:8px; left:8px; right:8px;
      background:white; padding:10px; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      z-index:1000; font-size:14px; max-width:560px;
    }
    h1{ margin:0 0 6px; font-size:14px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; margin:4px 0; align-items:center; }
    .grow{ flex:1; }
    button{ padding:6px 10px; border-radius:10px; border:1px solid #888; background:#f0f0f0; }
    #fabStop{ position:absolute; bottom:20px; right:20px; border-radius:50%; width:64px; height:64px; font-size:14px; font-weight:bold; background:red; color:white; display:none; z-index:1200; }
    .counts{ font-size:12px; margin-left:auto; }
    .small{ font-size:12px; color:#333; }

    /* iPhone等の狭い画面でメニューをコンパクト化 */
    @media (max-width:480px){
      #panel{ padding:8px 10px; border-radius:10px; font-size:12px; }
      h1{ font-size:13px; }
      button{ padding:6px 8px; min-height:32px; font-size:12px; }
      .row{ gap:6px; }
      .row.row-actions{ display:grid; grid-template-columns:1fr 1fr; gap:6px; }
      #fname{ display:none; }
    }

    /* 自車マーカー（赤塗り丸） */
    .custom-car { }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <h1>実車評価支援ツール</h1>

    <!-- ルート/ポイント読み込み -->
    <div class="row">
      <input type="file" id="file" accept=".kml,.kmz" multiple />
      <select id="datasetSelect" class="grow">
        <option value="" disabled selected>（読み込んだルート／ポイントを選択）</option>
      </select>
      <span id="fname" class="small"></span>
    </div>

    <!-- 主要操作 -->
    <div class="row row-actions">
      <button id="start">追跡開始</button>
      <button id="stop" disabled>追跡終了</button>
      <button id="recenter">現在地へ</button>
      <button id="cp" disabled>チェックポイント</button>
      <span id="counts" class="counts"></span>
    </div>

    <details id="adv" open>
      <summary class="small">詳細設定</summary>

      <div class="row">
        <label><input type="checkbox" id="keepCentered" checked />自車を常に中心</label>
        <label style="margin-left:10px">向き:</label>
        <label><input type="radio" name="orient" value="north" checked />北を上</label>
        <label><input type="radio" name="orient" value="course" />進行方向を上</label>
      </div>

      <div class="row">
        <button id="tts">音声テスト</button>
        <select id="voiceSelect" class="small" style="min-width:200px"></select>
        <button id="wake">画面オフ防止: OFF</button>
      </div>

      <div class="row">
        <label class="small" for="ttsRate">話す速度: <span id="ttsRateVal">1.0</span>x</label>
        <input id="ttsRate" type="range" min="0.6" max="1.6" step="0.1" value="1.0" style="width:180px; margin-left:8px;">
      </div>

      <div class="row">
        <label class="small" for="notifyRange">通知半径: <span id="notifyRangeVal">120</span> m</label>
        <input id="notifyRange" type="range" min="50" max="300" step="10" value="120" style="width:180px; margin-left:8px;">
      </div>

      <!-- GPX保存：保存先選択 + ファイル名指定 -->
      <div class="row">
        <input id="gpxName" type="text" placeholder="ファイル名（例: route_YYYYMMDD.gpx）" style="min-width:220px;" />
        <button id="saveGpx" disabled>GPX保存</button>
        <span id="stat" class="small"></span>
      </div>
    </details>
  </div>

  <button id="fabStop">終了</button>

  <script src="leaflet.js"></script>
  <script src="jszip.min.js"></script>
  <script src="togeojson.umd.js"></script>
  <script>
    // ====== 地図初期化 ======
    const map = L.map('map').setView([35.0, 135.0], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

    // 自車マーカー（中も赤で塗りつぶし）
    const carIcon = L.divIcon({
      className: 'custom-car',
      html: '<div style="width:16px;height:16px;background:red;border-radius:50%;"></div>',
      iconSize: [16,16], iconAnchor: [8,8]
    });
    const carMarker = L.marker([35.0, 135.0], {icon:carIcon}).addTo(map);

    // ====== TTS（女性の声セレクタ対応） ======
    const ttsRate = document.getElementById('ttsRate');
    const ttsRateVal = document.getElementById('ttsRateVal');
    const voiceSelect = document.getElementById('voiceSelect');

    let voicesCache = [];
    let selectedVoice = null;

    const femalePreferRe = /(Kyoko|Mizuki|Sakura|Haruka|Yuna|Airi|Nozomi|Google\s*日本語\s*2?|女性|Female)/i;
    const maleRe        = /(Otoya|Ichiro|Ken|Taro|Hattori|男性|Male)/i;

    function pickDefaultFemaleJaVoice(vs){
      let v = vs.find(v => v.lang && v.lang.startsWith('ja') && femalePreferRe.test(v.name));
      if (v) return v;
      v = vs.find(v => v.lang && v.lang.startsWith('ja') && !maleRe.test(v.name));
      if (v) return v;
      return vs[0] || null;
    }

    function populateVoiceSelect(){
      voicesCache = window.speechSynthesis.getVoices();
      if (!voicesCache || !voicesCache.length) return; // iOSは最初0件のことがある
      const ja = voicesCache.filter(v => (v.lang||'').toLowerCase().startsWith('ja'));
      const rest = voicesCache.filter(v => !(v.lang||'').toLowerCase().startsWith('ja'));
      const ordered = [...ja, ...rest
