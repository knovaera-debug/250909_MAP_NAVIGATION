<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>実車評価支援ツール（GPX保存先・ファイル名指定対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    html, body { height:100%; margin:0; }
    #map { position:absolute; top:0; bottom:0; right:0; left:0; }
    #panel{
      position:absolute; top:8px; left:8px; right:8px;
      background:white; padding:10px; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      z-index:1000;
      font-size:14px; max-width:560px;
    }
    h1{ margin:0 0 6px; font-size:14px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; margin:4px 0; align-items:center; }
    .grow{ flex:1; }
    button{ padding:6px 10px; border-radius:10px; border:1px solid #888; background:#f0f0f0; }
    #fabStop{ position:absolute; bottom:20px; right:20px; border-radius:50%; width:64px; height:64px; font-size:14px; font-weight:bold; background:red; color:white; display:none; z-index:1200; }
    .counts{ font-size:12px; margin-left:auto; }
    .small{ font-size:12px; color:#333; }

    /* iPhone等の狭い画面でメニューをコンパクト化 */
    @media (max-width:480px){
      #panel{ padding:8px 10px; border-radius:10px; font-size:12px; }
      h1{ font-size:13px; }
      button{ padding:6px 8px; min-height:32px; font-size:12px; }
      .row{ gap:6px; }
      .row.row-actions{ display:grid; grid-template-columns:1fr 1fr; gap:6px; }
      #fname{ display:none; }
    }

    /* 自車マーカー（赤塗り丸） */
    .custom-car { }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel">
    <h1>実車評価支援ツール</h1>

    <!-- ルート/ポイント読み込み -->
    <div class="row">
      <input type="file" id="file" accept=".kml,.kmz" multiple />
      <select id="datasetSelect" class="grow">
        <option value="" disabled selected>（読み込んだルート／ポイントを選択）</option>
      </select>
      <span id="fname" class="small"></span>
    </div>

    <!-- 主要操作 -->
    <div class="row row-actions">
      <button id="start">追跡開始</button>
      <button id="stop" disabled>追跡終了</button>
      <button id="recenter">現在地へ</button>
      <button id="cp" disabled>チェックポイント</button>
      <span id="counts" class="counts"></span>
    </div>

    <details id="adv" open>
      <summary class="small">詳細設定</summary>

      <div class="row">
        <label><input type="checkbox" id="keepCentered" checked />自車を常に中心</label>
        <label style="margin-left:10px">向き:</label>
        <label><input type="radio" name="orient" value="north" checked />北を上</label>
        <label><input type="radio" name="orient" value="course" />進行方向を上</label>
      </div>

      <div class="row">
        <button id="tts">音声テスト</button>
        <button id="wake">画面オフ防止: OFF</button>
      </div>

      <div class="row">
        <label class="small" for="ttsRate">話す速度: <span id="ttsRateVal">1.0</span>x</label>
        <input id="ttsRate" type="range" min="0.6" max="1.6" step="0.1" value="1.0" style="width:180px; margin-left:8px;">
      </div>

      <div class="row">
        <label class="small" for="notifyRange">通知半径: <span id="notifyRangeVal">120</span> m</label>
        <input id="notifyRange" type="range" min="50" max="300" step="10" value="120" style="width:180px; margin-left:8px;">
      </div>

      <!-- GPX保存：保存先選択 + ファイル名指定 -->
      <div class="row">
        <input id="gpxName" type="text" placeholder="ファイル名（例: route_YYYYMMDD.gpx）" style="min-width:220px;" />
        <button id="saveGpx" disabled>GPX保存</button>
        <span id="stat" class="small"></span>
      </div>
    </details>
  </div>

  <button id="fabStop">終了</button>

  <script src="leaflet.js"></script>
  <script src="jszip.min.js"></script>
  <script src="togeojson.umd.js"></script>
  <script>
    // ====== 地図初期化 ======
    const map = L.map('map').setView([35.0, 135.0], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

    // 自車マーカー（中も赤で塗りつぶし）
    const carIcon = L.divIcon({
      className: 'custom-car',
      html: '<div style="width:16px;height:16px;background:red;border-radius:50%;"></div>',
      iconSize: [16,16], iconAnchor: [8,8]
    });
    const carMarker = L.marker([35.0, 135.0], {icon:carIcon}).addTo(map);

    // ====== TTS（女性の声優先） ======
    const ttsRate = document.getElementById('ttsRate');
    const ttsRateVal = document.getElementById('ttsRateVal');
    function pickFemaleJaVoice(){
      const vs = speechSynthesis.getVoices();
      return (
        vs.find(v => v.lang.startsWith('ja') && (/Female|女|女性/i.test(v.name))) ||
        vs.find(v => v.lang.startsWith('ja')) ||
        vs[0]
      );
    }
    let cachedVoice = null;
    function speak(text){
      const u = new SpeechSynthesisUtterance(text);
      cachedVoice = cachedVoice || pickFemaleJaVoice();
      if (cachedVoice) u.voice = cachedVoice;
      const rate = parseFloat(ttsRate.value || '1.0');
      u.rate = rate; // 速度反映
      speechSynthesis.speak(u);
    }
    window.speechSynthesis.onvoiceschanged = () => { cachedVoice = pickFemaleJaVoice(); };
    document.getElementById('tts').addEventListener('click',()=>{ speak('音声テストです。女性の声で読み上げます。'); });
    ttsRate.addEventListener('input',()=>{ ttsRateVal.textContent = ttsRate.value; });

    // ====== 追跡（軌跡記録） ======
    let watching = null;
    let tracking = false;
    let points = []; // {lat, lon, time}
    let poly = L.polyline([], { color:'#d00', weight:4 }).addTo(map);

    const startBtn = document.getElementById('start');
    const stopBtn  = document.getElementById('stop');
    const fabStop  = document.getElementById('fabStop');
    const recenterBtn = document.getElementById('recenter');
    const cpBtn = document.getElementById('cp');
    const keepCentered = document.getElementById('keepCentered');
    const counts = document.getElementById('counts');

    function updateCounts(){ counts.textContent = `点:${points.length}`; }

    function onLoc(pos){
      const { latitude:lat, longitude:lon } = pos.coords;
      const now = new Date();
      carMarker.setLatLng([lat, lon]);
      if (tracking){
        points.push({lat, lon, time: now.toISOString()});
        poly.addLatLng([lat, lon]);
      }
      if (keepCentered.checked) map.setView([lat, lon]);
    }
    function onLocErr(err){ console.warn(err); }

    function startTracking(){
      if (tracking) return;
      tracking = true;
      startBtn.disabled = true; stopBtn.disabled = false; cpBtn.disabled = false;
      fabStop.style.display = 'block';
      speak('追跡を開始します。');
      if (!watching) watching = navigator.geolocation.watchPosition(onLoc, onLocErr, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
      document.getElementById('adv').open = false; // モバイルで視界を広く
    }

    function stopTracking(){
      if (!tracking) return;
      tracking = false;
      startBtn.disabled = false; stopBtn.disabled = true; cpBtn.disabled = true;
      fabStop.style.display = 'none';
      speak('追跡を終了しました。');
      document.getElementById('saveGpx').disabled = points.length === 0;
      document.getElementById('adv').open = true;
      updateCounts();
    }

    startBtn.addEventListener('click', startTracking);
    stopBtn.addEventListener('click', stopTracking);
    fabStop.addEventListener('click', stopTracking);

    recenterBtn.addEventListener('click', ()=>{
      if (points.length){
        const p = points[points.length-1];
        map.setView([p.lat, p.lon]);
      }
    });

    // チェックポイント（現在地に小さい赤丸を落とす）
    let cpLayer = L.layerGroup().addTo(map);
    cpBtn.addEventListener('click', ()=>{
      if (!points.length) return;
      const p = points[points.length-1];
      L.circleMarker([p.lat, p.lon], { radius:6, color:'#a00', weight:2, fillColor:'#f66', fillOpacity:0.9 }).addTo(cpLayer);
      speak('チェックポイント。');
    });

    // ====== GPX生成 & 保存 ======
    function buildGpx(){
      if (!points.length) return '';
      const header = `<?xml version="1.0" encoding="UTF-8"?>\n`+
        `<gpx version="1.1" creator="RouteHelper" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n`+
        `<trk><name>track</name><trkseg>`;
      const body = points.map(p=>`<trkpt lat="${p.lat}" lon="${p.lon}"><time>${p.time}</time></trkpt>`).join('');
      const footer = `</trkseg></trk></gpx>`;
      return header + body + footer;
    }

    async function saveTextFileInteractively(defaultName, text, mime = 'application/gpx+xml'){
      const blob = new Blob([text], {type: mime});
      if (window.showSaveFilePicker) {
        try {
          const handle = await window.showSaveFilePicker({
            suggestedName: defaultName,
            types: [{ description: 'GPX file', accept: {'application/gpx+xml': ['.gpx']} }]
          });
          const writable = await handle.createWritable();
          await writable.write(blob); await writable.close();
          return {ok:true, method:'fs-access'};
        } catch(e){ /* フォールバック */ }
      }
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = defaultName || 'track.gpx';
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
      return {ok:true, method:'download'};
    }

    const saveBtn = document.getElementById('saveGpx');
    const nameInput = document.getElementById('gpxName');
    saveBtn.addEventListener('click', async ()=>{
      const gpx = buildGpx();
      if (!gpx){ alert('GPXデータがまだありません。'); return; }
      let fn = (nameInput && nameInput.value.trim()) || '';
      if (!fn) {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd= String(d.getDate()).padStart(2,'0');
        fn = `route_${y}${m}${dd}.gpx`;
        if (nameInput) nameInput.value = fn;
      }
      if (!fn.toLowerCase().endsWith('.gpx')) fn += '.gpx';
      const res = await saveTextFileInteractively(fn, gpx);
      const stat = document.getElementById('stat');
      if (stat){
        stat.textContent = res.method === 'fs-access' ? '保存しました（指定場所）' : '保存しました（ダウンロード）';
        setTimeout(()=> stat.textContent = '', 3000);
      }
    });

    // ====== ルート/ポイント読込（KML/KMZ対応・toGeoJSON） ======
    const fileInput = document.getElementById('file');
    const datasetSelect = document.getElementById('datasetSelect');
    let datasets = {}; // name -> { geojson, layer }

    fileInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files || []);
      for (const f of files){
        if (f.name.toLowerCase().endsWith('.kml')){
          const txt = await f.text();
          const dom = new DOMParser().parseFromString(txt, 'text/xml');
          const gj = toGeoJSON.kml(dom);
          addDataset(f.name, gj);
        } else if (f.name.toLowerCase().endsWith('.kmz')){
          const zip = await JSZip.loadAsync(await f.arrayBuffer());
          const kmlEntry = zip.file(/\.kml$/i)[0];
          if (kmlEntry){
            const txt = await kmlEntry.async('text');
            const dom = new DOMParser().parseFromString(txt, 'text/xml');
            const gj = toGeoJSON.kml(dom);
            addDataset(f.name.replace(/\.kmz$/i,'.kml'), gj);
          }
        }
      }
    });

    function addDataset(name, gj){
      const layer = L.geoJSON(gj, {
        style: { color:'#0066cc', weight:3 },
        pointToLayer: (feat, latlng)=> L.circleMarker(latlng, { radius:6, color:'#0066cc', weight:2, fillColor:'#66aaff', fillOpacity:0.9 })
      }).addTo(map);
      map.fitBounds(layer.getBounds(), {padding:[20,20]});
      datasets[name] = { geojson: gj, layer };
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name; datasetSelect.appendChild(opt);
    }

    datasetSelect.addEventListener('change', ()=>{
      const sel = datasetSelect.value;
      Object.entries(datasets).forEach(([n, v])=>{ v.layer.setStyle && v.layer.setStyle({opacity: n===sel?1:0.35}); v.layer.setZIndex && v.layer.setZIndex(n===sel?10:1); });
    });

    // ====== 画面オフ防止 ======
    const wakeBtn = document.getElementById('wake');
    let wakeLock = null;
    async function toggleWake(){
      if (!wakeLock){
        try{ wakeLock = await navigator.wakeLock.request('screen'); wakeBtn.textContent = '画面オフ防止: ON'; }
        catch(e){ alert('この端末/ブラウザは画面オフ防止に対応していない可能性があります。'); }
      } else {
        try{ await wakeLock.release(); } catch(e){}
        wakeLock = null; wakeBtn.textContent = '画面オフ防止: OFF';
      }
    }
    wakeBtn.addEventListener('click', toggleWake);

    // 初期状態
    document.getElementById('saveGpx').disabled = true;
    updateCounts();
  </script>
</body>
</html>
